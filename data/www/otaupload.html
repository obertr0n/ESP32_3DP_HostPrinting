<!DOCTYPE html>
<meta charset="UTF-8">

<html>

<head>
    <link rel="stylesheet" type="text/css" href="/www/style.css">
    <title>ESP32 FwUpload</title>
</head>

<body>
    <div id="otaupload">
        <form method='POST' name='uploadform' enctype='multipart/form-data' id='uploadfrm'>
            <input type='file' name='userfile' id='inpfile' onchange='sub(this)'>
            <div style="text-align: center;">
                <label id='linpfile' for='inpfile'>Choose update file...</label>
            </div>
            <div style="text-align: center;">
                <br>
                <input type='submit' class=uploadbtn value='Update'>
            </div>
            <div id='prgtxt'></div>
            <br>
            <div id='prgbar'>
                <div id='iprgbar'> </div>
            </div>
        </form>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadfrm');
        const inputFile = document.getElementById('inpfile');
        const progTxt = document.getElementById('prgtxt');
        const progBar = document.getElementById('iprgbar');
        const lInputFile = document.getElementById('linpfile');

        uploadForm.addEventListener('submit', submitFile);

        function sub(obj) {
            var fileName = obj.value.split('\\');
            lInputFile.innerHTML = '   ' + fileName[fileName.length - 1];
        };

        function submitFile(ev) {
            ev.preventDefault();
            progTxt.style.color = '#777';
            if (inputFile.files.length === 0) {
                progTxt.innerHTML = 'Choose a file first';
                progTxt.style.color = 'red';
                return;
            }

            var xhr = new window.XMLHttpRequest();
            var formData = new FormData();
            var xhr = new window.XMLHttpRequest();

            xhr.upload.onprogress = function(ev) {
                if (ev.lengthComputable) {
                    var per = ev.loaded / ev.total;
                    progTxt.innerHTML = 'progress: ' + Math.round(per * 100) + '%';
                    progBar.style.width = Math.round(per * 100) + '%';
                }
            }
            xhr.onloadend = function() {
                if (xhr.status == 200) {
                    progTxt.innerHTML = 'Success'
                    progTxt.style.color = 'green';
                } else {
                    progTxt.innerHTML = 'Upload Failed'
                    progTxt.style.color = 'red';
                }
            };
            var frmData = new FormData();
            frmData.append('userfile', inputFile.files[0])

            xhr.open('POST', '/fwupload', true);
            xhr.send(frmData);

        };
    </script>
</body>

</html>